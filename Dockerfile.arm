FROM quay.io/pypa/manylinux2014_aarch64

# manylinux2014 is specifically built for CentOS 7 compatibility (glibc 2.17)
# This avoids all the CentOS 7 EOL repository issues

# Install system packages for building libvirt
RUN yum install -y \
    gcc \
    gcc-c++ \
    make \
    pkgconfig \
    wget \
    unzip \
    python3 \
    libxml2-devel \
    gnutls-devel \
    device-mapper-devel \
    libpciaccess-devel \
    yajl-devel \
    libnl3-devel \
    libxslt \
    libtirpc-devel \
    && yum clean all

# Install libvirt 6.10.0 from source (has cgroup V2 and RSS support, still CentOS 7 compatible)
RUN cd /tmp && \
    echo "Building libvirt 6.10.0 with cgroup V2 and RSS support..." && \
    # Use Python 3.9 from manylinux and install Meson and Ninja build system
    /opt/python/cp39-cp39/bin/python3.9 -m pip install meson ninja docutils && \
    export PATH="/opt/python/cp39-cp39/bin:$PATH" && \
    wget https://libvirt.org/sources/libvirt-6.10.0.tar.xz && \
    tar xf libvirt-6.10.0.tar.xz && \
    cd libvirt-6.10.0 && \
    meson setup builddir \
        --prefix=/usr \
        --localstatedir=/var \
        --sysconfdir=/etc \
        -Ddriver_qemu=disabled \
        -Ddriver_lxc=disabled \
        -Ddriver_openvz=disabled \
        -Ddriver_vmware=disabled \
        -Ddriver_vbox=disabled \
        -Ddriver_libxl=disabled \
        -Ddriver_vz=disabled \
        -Ddriver_bhyve=disabled \
        -Ddriver_hyperv=disabled \
        -Dtests=disabled \
        -Dbuildtype=release \
        --default-library=shared && \
    ninja -C builddir && \
    ninja -C builddir install && \
    echo "/usr/lib64" > /etc/ld.so.conf.d/libvirt.conf && \
    echo "/usr/lib" >> /etc/ld.so.conf.d/libvirt.conf && \
    ldconfig && \
    cd / && rm -rf /tmp/libvirt-6.10.0* /tmp/meson* /tmp/ninja*

# Find and set up the best available Python version from manylinux2014
RUN echo "Setting up Python from manylinux2014..." && \
    PYTHON_PATH="" && \
    # Try different Python versions in order of preference for this base
    for version in cp39 cp38 cp37; do \
        for pydir in /opt/python/${version}*; do \
            if [ -d "$pydir" ] && [ -f "$pydir/bin/python" ]; then \
                PYTHON_PATH="$pydir"; \
                echo "Found Python at: $pydir"; \
                $pydir/bin/python --version; \
                break 2; \
            fi; \
        done; \
    done && \
    if [ -z "$PYTHON_PATH" ]; then \
        echo "No suitable Python found in:"; \
        ls -la /opt/python/; \
        exit 1; \
    fi && \
    echo "PYTHON_PATH=$PYTHON_PATH" > /etc/python_path && \
    echo "export PATH=\"$PYTHON_PATH/bin:\$PATH\"" >> /etc/profile && \
    echo "export PKG_CONFIG_PATH=\"/usr/lib64/pkgconfig:/usr/lib/pkgconfig:\$PKG_CONFIG_PATH\"" >> /etc/profile && \
    ln -sf $PYTHON_PATH/bin/python /usr/local/bin/python && \
    ln -sf $PYTHON_PATH/bin/pip /usr/local/bin/pip

# Configure libcrypt path for PyInstaller compatibility
RUN echo "=== Configuring libcrypt for PyInstaller ===" && \
    # Add /usr/local/lib to library search path
    echo "/usr/local/lib" >> /etc/ld.so.conf.d/libcrypt.conf && \
    # Create symlinks in standard locations for PyInstaller
    ln -sf /usr/local/lib/libcrypt.so.1 /usr/lib64/libcrypt.so.1 && \
    ln -sf /usr/local/lib/libcrypt.so.2 /usr/lib64/libcrypt.so.2 && \
    # Update library cache
    ldconfig && \
    echo "libcrypt configuration complete" && \
    ls -la /usr/lib64/libcrypt.so*

# Set environment variables
ENV BASH_ENV=/etc/profile
ENV PKG_CONFIG_PATH="/usr/lib64/pkgconfig:/usr/lib/pkgconfig:/usr/lib64/pkgconfig"
ENV PATH="/usr/local/bin:$PATH"

# Comprehensive verification
RUN . /etc/profile && \
    echo "=== Build Environment Verification ===" && \
    echo "Base: manylinux2014 (CentOS 7 compatible - glibc 2.17)" && \
    echo "Host glibc: $(ldd --version | head -n1)" && \
    echo "Python version: $(python --version)" && \
    echo "Python path: $(which python)" && \
    echo "libvirt version: $(pkg-config --modversion libvirt)" && \
    echo "libvirt libs: $(pkg-config --libs libvirt)" && \
    echo "Checking for libvirt libraries:" && \
    ls -la /usr/lib64/libvirt.so* 2>/dev/null || echo "libvirt libraries not found" && \
    python -c "import sysconfig; print('Python include path:', sysconfig.get_path('include'))" && \
    PYTHON_PATH=$(cat /etc/python_path | cut -d= -f2) && \
    find $PYTHON_PATH -name "Python.h" | head -1 && \
    echo "manylinux2014 + libvirt 4.5.0 setup complete - should have RSS support and CentOS 7 compatibility!"

ENV TARGET_ARCH="arm64"
WORKDIR /workspace
CMD ["bash"]
