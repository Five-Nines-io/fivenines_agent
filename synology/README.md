# Synology DSM SPK Packaging

This directory contains scaffolding to build and package fivenines-agent for
Synology DSM 7 as an SPK (Synology Package).

## Prerequisites

- DSM 7.0 or later (tested on DSM 7.x)
- x86_64 or aarch64 architecture NAS
- A fivenines.io account with an API token

## Build

### 1. Build the binary

Run inside the manylinux2014 Docker build environment (same as CI):

```bash
TARGET_ARCH=amd64 ./py2exe_synology.sh
# or
TARGET_ARCH=arm64 ./py2exe_synology.sh
```

This produces `./dist/linux/fivenines-agent-synology-{amd64|arm64}/`.

Key differences from the standard build:
- libvirt-python is uninstalled (not available on NAS hardware)
- systemd-watchdog is uninstalled (DSM does not use systemd)
- libtirpc is not bundled (only needed for libvirt)

### 2. Assemble the SPK

```bash
./synology/build_spk.sh 1.5.4 x86_64
# or
./synology/build_spk.sh 1.5.4 aarch64
```

The SPK is written to `./dist/synology/fivenines-agent-<version>-<arch>.spk`.

## Installation

1. Open Synology Package Center
2. Click **Manual Install**
3. Upload the `.spk` file
4. Follow the wizard â€” enter your fivenines.io API token when prompted
5. The agent starts automatically after installation

The token is stored at `/var/packages/fivenines-agent/etc/TOKEN`.

## File Structure

Layout follows the [Synology Package Introduction](https://help.synology.com/developer-guide/synology_package/introduction.html). Required items (INFO, package.tgz, scripts, conf, PACKAGE_ICON.PNG, PACKAGE_ICON_256.PNG) are included so Package Center accepts the SPK.

```
synology/
  INFO.template            Package metadata (VERSION and ARCH; arch uses armv8 for aarch64)
  build_spk.sh             Assembles the SPK from a built binary
  gen_icons.py             Generates required 64x64 and 256x256 PNG icons (stdlib only)
  scripts/
    start-stop-status      Start/stop/status daemon control
    postinst               Writes wizard token to config (required)
    preinst, preuninst, postuninst, preupgrade, postupgrade   Required lifecycle stubs
  conf/
    privilege              DSM 7 privilege (run-as package)
  WIZARD_UIFILES/
    install_uifile         Token input UI during install
```

Icons are generated by `gen_icons.py` at build time if not present; SPK filename keeps `aarch64` for clarity while INFO uses `arch=armv8` per Synology's platform mapping.

## Notes

- The agent runs as `sc-fivenines-agent` (a custom low-privilege internal user).
  Because it does not run as `root`, some deep system telemetry (e.g., SMART data, hardware sensors) may be inaccessible depending on your NAS model's file permissions. This is gracefully handled and ignored.
- QEMU/libvirt and Proxmox monitoring are gracefully disabled (the libraries
  are not available on NAS hardware).
- synopkg is supported for package security scanning.
- Log file: `/var/packages/fivenines-agent/var/agent.log`
- PID file: `/var/packages/fivenines-agent/var/agent.pid`
