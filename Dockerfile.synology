ARG BASE_IMAGE=quay.io/pypa/manylinux2014_x86_64
FROM ${BASE_IMAGE}

# Minimal build environment for Synology DSM builds.
# No libvirt or libtirpc - those are not needed for Synology.

RUN yum install -y \
    gcc \
    gcc-c++ \
    make \
    pkgconfig \
    wget \
    unzip \
    rsync \
    && yum clean all

# Set up Python 3.9 from manylinux
RUN echo "Setting up Python from manylinux2014..." && \
    for version in cp39 cp38 cp37; do \
        for pydir in /opt/python/${version}*; do \
            if [ -d "$pydir" ] && [ -f "$pydir/bin/python" ]; then \
                echo "Found Python at: $pydir"; \
                $pydir/bin/python --version; \
                echo "export PATH=\"$pydir/bin:\$PATH\"" >> /etc/profile; \
                ln -sf $pydir/bin/python /usr/local/bin/python; \
                ln -sf $pydir/bin/pip /usr/local/bin/pip; \
                break 2; \
            fi; \
        done; \
    done

# Configure libcrypt path for PyInstaller compatibility
RUN echo "/usr/local/lib" >> /etc/ld.so.conf.d/libcrypt.conf && \
    ldconfig

ENV BASH_ENV=/etc/profile
ENV TARGET_ARCH="amd64"
WORKDIR /workspace
CMD ["bash"]
